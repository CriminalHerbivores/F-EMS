<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" 
"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<!--  [[개정이력(Modification Information)]]        -->
<!--  수정일       수정자      수정내용             -->
<!--  ==========   ======    ==============         -->
<!--  $2017.01.24    KJH       최초작성             -->
<!--  $2017.02.20    KJH       추가작성             -->
<!--  Copyright (c) 2017 by DDIT All right reserved -->

<sqlMap namespace="Reqst">
	<typeAlias alias="reqst" type="com.uni.fems.dto.ReqstVO" />
	<typeAlias alias="lctre_Search" type="com.uni.fems.dto.Lctre_SearchVO" />
	
	<!-- 수강신청 완료 목록 조회 -->
	<select id="selectReqst" parameterClass="str" resultClass="lctre_Search">
		SELECT * FROM lctre_view, reqst,intrst_list
		WHERE re_Lctre_No=lc_Lctre_No
   		and in_Lctre_No=lc_Lctre_No
   		and re_Stdnt_No=in_Stdnt_No
   		and re_Stdnt_No=#re_Stdnt_No# 
   		and in_Stdnt_No=#in_Stdnt_No#
 		and lc_Lctrbgn_Dt between (select add_months(sysdate,-4) from dual) and (select add_months(sysdate,1) from dual)
		and lc_Open_At='y'
		order by lc_Lctre_Code asc
	 </select>

	<!-- 수강 신청 -->
	<update id="insertReqst" parameterClass="reqst">
		MERGE INTO REQST
		USING DUAL
		on (re_Stdnt_No=#re_Stdnt_No# and re_Lctre_No=#re_Lctre_No#)
		WHEN NOT MATCHED THEN
		INSERT (re_Stdnt_No,re_Lctre_No)
		VALUES(#re_Stdnt_No#,#re_Lctre_No#)
	</update>
	
	<!-- 수강 신청 취소 -->
	<update id="deleteReqst" parameterClass="reqst">
		delete from REQST where re_Stdnt_No=#re_Stdnt_No# and re_Lctre_No=#re_Lctre_No#
	</update>
	
	<!-- 접속한 학생의 개설된 학기에서의 수강 신청한 학점의 합계 조회 -->
	<select id="getSumReqst" parameterClass="reqst" resultClass="int">
		select nvl(sum(to_number(substr(lu_Pnt,1,1))),0) from COURSE_VIEW 
		where re_Stdnt_No=#re_Stdnt_No#
		and lc_Lctrbgn_Dt between (select add_months(sysdate,-4) from dual) and (select add_months(sysdate,1) from dual)
	</select>
	
	
	<!-- ==================== 수강 신청 및 취소로 인한 인원 조절 ==================== -->
	
	<!-- 인원 조절할 강의의 강의실 수용인원 -->
	<select id="acceptNumOfStdnt" resultClass="int">
		select lr_Accept_Nmpr from lctre
		inner join lctrum on (lr_Lctrum_No = lc_Lctrum_No)
		where lc_Lctre_No=#lc_Lctre_No#
	</select>
	
	<!-- 그 과목을 수강중인 학생수 -->
	<select id="stdntNumOfLctre" resultClass="int">
		select count(*) from reqst where re_Lctre_No=#re_Lctre_No#
	</select>
	
	<!-- 그 과목의 수강 학생 변경 : 학생의 수강 신청과 연결하기 -->
	<update id="setNumOfStdnt" parameterClass="lctre_Search">
		update lctre set lc_Lctre_Nmpr = (select count(*) from reqst where re_Lctre_No=#re_Lctre_No#)
		where lc_Lctre_No=#re_Lctre_No# 
		and (select count(*) from reqst where re_Lctre_No=#re_Lctre_No#) > 0
		and <![CDATA[ lc_Lctre_Nmpr < (select lr_Accept_Nmpr from lctrum, lctre where lr_Lctrum_No=lc_Lctrum_No and lc_Lctre_No=#re_Lctre_No#) ]]>
	</update>

</sqlMap>